# .github/workflows/tests.yml
# Configuration GitHub Actions pour les tests automatisÃ©s

name: Tests AutomatisÃ©s - Gestion Factures

on:
  # ExÃ©cution sur push
  push:
    branches: [main, develop]
    paths:
      - 'src/**'
      - 'tests/**'
      - 'package.json'
  
  # ExÃ©cution sur pull request
  pull_request:
    branches: [main, develop]
  
  # ExÃ©cution planifiÃ©e (toutes les 6 heures)
  schedule:
    - cron: '0 */6 * * *'
  
  # ExÃ©cution manuelle
  workflow_dispatch:
    inputs:
      test_type:
        description: 'Type de tests Ã  exÃ©cuter'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - unit
          - integration
          - e2e
          - factures

env:
  NODE_VERSION: '18.x'

jobs:
  # ============================================
  # JOB: Tests unitaires
  # ============================================
  unit-tests:
    name: ğŸ§ª Tests Unitaires
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout du code
        uses: actions/checkout@v4
      
      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: ğŸ“š Installation des dÃ©pendances
        run: npm ci
      
      - name: ğŸ§ª ExÃ©cution des tests unitaires
        run: npm run test:unit -- --coverage --coverageReporters=json-summary
      
      - name: ğŸ“Š Upload couverture
        uses: codecov/codecov-action@v3
        with:
          file: ./coverage/coverage-summary.json
          flags: unit
          name: unit-tests
      
      - name: ğŸ“„ Upload rapport de tests
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: unit-test-report
          path: reports/
          retention-days: 30

  # ============================================
  # JOB: Tests d'intÃ©gration
  # ============================================
  integration-tests:
    name: ğŸ”— Tests d'IntÃ©gration
    runs-on: ubuntu-latest
    needs: unit-tests
    
    steps:
      - name: ğŸ“¥ Checkout du code
        uses: actions/checkout@v4
      
      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: ğŸ“š Installation des dÃ©pendances
        run: npm ci
      
      - name: ğŸ”— ExÃ©cution des tests d'intÃ©gration
        run: npm run test:integration -- --coverage
      
      - name: ğŸ“Š Upload couverture
        uses: codecov/codecov-action@v3
        with:
          flags: integration
          name: integration-tests
      
      - name: ğŸ“„ Upload rapport
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: integration-test-report
          path: reports/
          retention-days: 30

  # ============================================
  # JOB: Tests E2E
  # ============================================
  e2e-tests:
    name: ğŸ¯ Tests E2E
    runs-on: ubuntu-latest
    needs: integration-tests
    
    steps:
      - name: ğŸ“¥ Checkout du code
        uses: actions/checkout@v4
      
      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: ğŸ“š Installation des dÃ©pendances
        run: npm ci
      
      - name: ğŸ¯ ExÃ©cution des tests E2E
        run: npm run test:e2e
      
      - name: ğŸ“„ Upload rapport
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: e2e-test-report
          path: reports/
          retention-days: 30

  # ============================================
  # JOB: Tests complets des factures
  # ============================================
  factures-tests:
    name: ğŸ“‹ Tests Factures (Complet)
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout du code
        uses: actions/checkout@v4
      
      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: ğŸ“š Installation des dÃ©pendances
        run: npm ci
      
      - name: ğŸ“‹ ExÃ©cution des tests factures
        run: npm run test:factures -- --coverage --coverageReporters=html
      
      - name: ğŸ“Š Upload couverture HTML
        uses: actions/upload-artifact@v3
        with:
          name: factures-coverage-report
          path: coverage/
          retention-days: 30

  # ============================================
  # JOB: Rapport de couverture global
  # ============================================
  coverage-report:
    name: ğŸ“ˆ Rapport de Couverture
    runs-on: ubuntu-latest
    needs: [unit-tests, integration-tests, e2e-tests]
    if: always()
    
    steps:
      - name: ğŸ“¥ Checkout du code
        uses: actions/checkout@v4
      
      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: ğŸ“š Installation des dÃ©pendances
        run: npm ci
      
      - name: ğŸ“Š GÃ©nÃ©ration du rapport complet
        run: npm run test:coverage
      
      - name: ğŸ“ˆ VÃ©rification des seuils de couverture
        run: |
          COVERAGE=$(cat coverage/coverage-summary.json | jq '.total.lines.pct')
          echo "Couverture actuelle: $COVERAGE%"
          if (( $(echo "$COVERAGE < 50" | bc -l) )); then
            echo "âš ï¸ Couverture insuffisante (< 50%)"
            exit 1
          fi
          echo "âœ… Couverture suffisante"
      
      - name: ğŸ“„ Upload rapport final
        uses: actions/upload-artifact@v3
        with:
          name: full-coverage-report
          path: coverage/
          retention-days: 90

  # ============================================
  # JOB: Notification
  # ============================================
  notify:
    name: ğŸ“§ Notification
    runs-on: ubuntu-latest
    needs: [unit-tests, integration-tests, e2e-tests, factures-tests]
    if: always()
    
    steps:
      - name: ğŸ“Š RÃ©sumÃ© des tests
        run: |
          echo "## ğŸ“Š RÃ©sumÃ© des Tests" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Statut |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Tests Unitaires | ${{ needs.unit-tests.result == 'success' && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Tests IntÃ©gration | ${{ needs.integration-tests.result == 'success' && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Tests E2E | ${{ needs.e2e-tests.result == 'success' && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Tests Factures | ${{ needs.factures-tests.result == 'success' && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
      
      - name: ğŸ“§ Notification Slack (optionnel)
        if: failure()
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          channel: '#tests-alerts'
          text: 'âŒ Les tests automatisÃ©s ont Ã©chouÃ©!'
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK }}
        continue-on-error: true