{"version":3,"names":["_react","require","_factureConstants","useFactureInitialization","mode","idFacture","factureActions","isFullyInitialized","setIsFullyInitialized","useState","isInitialLoadDone","setIsInitialLoadDone","initialFormData","setInitialFormData","initRef","useRef","hasInitialized","currentMode","currentId","isProcessing","chargerFacture","fetchProchainNumeroFacture","chargerClients","setFacture","setIsLoading","getFormData","useEffect","console","log","typeIdFacture","current","FORM_MODES","VIEW","EDIT","initializeData","factureDataRef","CREATE","today","Date","prev","dateFacture","toISOString","split","numeroFacture","idClient","lignes","getFullYear","loadedFacture","setTimeout","finalFormData","ristourne","montantTotal","totalAvecRistourne","error","exports"],"sources":["useFactureInitialization.js"],"sourcesContent":["import { useState, useEffect, useRef } from 'react';\r\nimport { FORM_MODES } from '../../../constants/factureConstants';\r\n\r\nexport const useFactureInitialization = (mode, idFacture, factureActions) => {\r\n  const [isFullyInitialized, setIsFullyInitialized] = useState(false);\r\n  const [isInitialLoadDone, setIsInitialLoadDone] = useState(false);\r\n  const [initialFormData, setInitialFormData] = useState({});\r\n\r\n  // âœ… PROTECTION TOTALE contre les appels multiples\r\n  const initRef = useRef({\r\n    hasInitialized: false,\r\n    currentMode: null,\r\n    currentId: null,\r\n    isProcessing: false\r\n  });\r\n\r\n  const { chargerFacture, fetchProchainNumeroFacture, chargerClients, setFacture, setIsLoading, getFormData } = factureActions;\r\n\r\n  // âœ… EFFET UNIQUE simplifiÃ© avec protection totale\r\n  useEffect(() => {\r\n    const currentMode = mode;\r\n    const currentId = idFacture;\r\n    \r\n    console.log('ðŸ” useFactureInitialization - useEffect dÃ©clenchÃ©:', {\r\n      mode: currentMode,\r\n      idFacture: currentId,\r\n      typeIdFacture: typeof currentId\r\n    });\r\n\r\n    // âœ… VERIFICATIONS DE SECURITE\r\n    // 1. VÃ©rifier si dÃ©jÃ  en cours de traitement\r\n    if (initRef.current.isProcessing) {\r\n      console.log('â¸ï¸ Traitement dÃ©jÃ  en cours, abandon');\r\n      return;\r\n    }\r\n\r\n    // 2. VÃ©rifier si dÃ©jÃ  initialisÃ© pour ces paramÃ¨tres EXACTS\r\n    if (initRef.current.hasInitialized && \r\n        initRef.current.currentMode === currentMode && \r\n        initRef.current.currentId === currentId) {\r\n      console.log('âœ… DÃ©jÃ  initialisÃ© pour ces paramÃ¨tres, skip');\r\n      return;\r\n    }\r\n\r\n    // 3. Si mode VIEW sans ID, ne pas initialiser\r\n    if ((currentMode === FORM_MODES.VIEW || currentMode === FORM_MODES.EDIT) && !currentId) {\r\n      console.log('âŒ Mode VIEW/EDIT sans ID, abandon');\r\n      setIsLoading(false);\r\n      return;\r\n    }\r\n\r\n    // âœ… DEBUT DU TRAITEMENT\r\n    const initializeData = async () => {\r\n      // Marquer comme en cours\r\n      initRef.current.isProcessing = true;\r\n\r\n      let factureDataRef = null;\r\n      \r\n      try {\r\n        console.log('ðŸš€ DÃ©but initialisation pour mode:', currentMode, 'ID:', currentId);\r\n\r\n        if (currentMode === FORM_MODES.CREATE) {\r\n          // âœ… MODE CREATION\r\n          console.log('ðŸ†• Initialisation mode crÃ©ation');\r\n          const today = new Date();\r\n          setFacture(prev => ({\r\n            ...prev,\r\n            dateFacture: today.toISOString().split('T')[0],\r\n            numeroFacture: '',\r\n            idClient: null,\r\n            lignes: []\r\n          }));\r\n          \r\n          await fetchProchainNumeroFacture(today.getFullYear());\r\n          \r\n        } else if ((currentMode === FORM_MODES.VIEW || currentMode === FORM_MODES.EDIT) && currentId) {\r\n          // âœ… MODE VIEW/EDIT avec ID\r\n          console.log('ðŸ”„ Chargement facture pour mode:', currentMode, 'ID:', currentId);\r\n          const loadedFacture = await chargerFacture(currentId);\r\n          console.log('ðŸ“¦ DonnÃ©es facture chargÃ©es:', loadedFacture);\r\n          \r\n          // Stocker les donnÃ©es pour l'initialisation\r\n          factureDataRef = loadedFacture;\r\n        }\r\n\r\n        // âœ… FINALISATION\r\n        console.log('âœ… Initialisation terminÃ©e pour mode:', currentMode);\r\n        \r\n        // Marquer comme traitÃ©\r\n        initRef.current.hasInitialized = true;\r\n        initRef.current.currentMode = currentMode;\r\n        initRef.current.currentId = currentId;\r\n        \r\n        setIsInitialLoadDone(true);\r\n        setIsLoading(false);\r\n        \r\n        // âœ… CORRECTION: Attendre plus longtemps pour que les donnÃ©es se propagent\r\n        if (currentMode === FORM_MODES.CREATE) {\r\n          // Mode crÃ©ation\r\n          setTimeout(() => {\r\n            const finalFormData = getFormData();\r\n            console.log('ðŸ“Š DonnÃ©es finales (CREATE):', finalFormData);\r\n            setInitialFormData(finalFormData);\r\n            setIsFullyInitialized(true);\r\n          }, 300);\r\n        } else if (factureDataRef) {  // âœ… ChangÃ© de factureData Ã  factureDataRef\r\n          // Mode EDIT/VIEW : utiliser directement factureDataRef de l'API\r\n          setTimeout(() => {\r\n            console.log('âœ… Utilisation des donnÃ©es API directes:', factureDataRef);\r\n            setInitialFormData({\r\n              numeroFacture: factureDataRef.numeroFacture || '',\r\n              dateFacture: factureDataRef.dateFacture || '',\r\n              idClient: factureDataRef.idClient || null,\r\n              lignes: factureDataRef.lignes || [],\r\n              ristourne: factureDataRef.ristourne || 0,\r\n              montantTotal: factureDataRef.montantTotal || 0,\r\n              totalAvecRistourne: factureDataRef.totalAvecRistourne || 0\r\n            });\r\n            setIsFullyInitialized(true);\r\n          }, 500);\r\n        }\r\n\r\n      } catch (error) {\r\n        console.error('âŒ Erreur lors de l\\'initialisation:', error);\r\n        setIsLoading(false);\r\n      } finally {\r\n        initRef.current.isProcessing = false;\r\n      }\r\n    };\r\n\r\n    // DÃ©marrer l'initialisation\r\n    initializeData();\r\n\r\n  }, [mode, idFacture]); // âœ… DEPENDANCES MINIMALES\r\n\r\n  // âœ… Cleanup lors du dÃ©montage\r\n  useEffect(() => {\r\n    return () => {\r\n      console.log('ðŸ§¹ Cleanup useFactureInitialization');\r\n      initRef.current = {\r\n        hasInitialized: false,\r\n        currentMode: null,\r\n        currentId: null,\r\n        isProcessing: false\r\n      };\r\n    };\r\n  }, []);\r\n\r\n  return {\r\n    isFullyInitialized,\r\n    setIsFullyInitialized,\r\n    isInitialLoadDone,\r\n    initialFormData,\r\n    setInitialFormData\r\n  };\r\n};"],"mappings":"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","ignoreList":[]}