36b66d65c1ac8686676080cc7463a6ee
"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.trackStream = exports.streamChunk = exports.readBytes = void 0;
const streamChunk = function* (chunk, chunkSize) {
  let len = chunk.byteLength;
  if (!chunkSize || len < chunkSize) {
    yield chunk;
    return;
  }
  let pos = 0;
  let end;
  while (pos < len) {
    end = pos + chunkSize;
    yield chunk.slice(pos, end);
    pos = end;
  }
};
exports.streamChunk = streamChunk;
const readBytes = async function* (iterable, chunkSize) {
  for await (const chunk of readStream(iterable)) {
    yield* streamChunk(chunk, chunkSize);
  }
};
exports.readBytes = readBytes;
const readStream = async function* (stream) {
  if (stream[Symbol.asyncIterator]) {
    yield* stream;
    return;
  }
  const reader = stream.getReader();
  try {
    for (;;) {
      const {
        done,
        value
      } = await reader.read();
      if (done) {
        break;
      }
      yield value;
    }
  } finally {
    await reader.cancel();
  }
};
const trackStream = (stream, chunkSize, onProgress, onFinish) => {
  const iterator = readBytes(stream, chunkSize);
  let bytes = 0;
  let done;
  let _onFinish = e => {
    if (!done) {
      done = true;
      onFinish && onFinish(e);
    }
  };
  return new ReadableStream({
    async pull(controller) {
      try {
        const {
          done,
          value
        } = await iterator.next();
        if (done) {
          _onFinish();
          controller.close();
          return;
        }
        let len = value.byteLength;
        if (onProgress) {
          let loadedBytes = bytes += len;
          onProgress(loadedBytes);
        }
        controller.enqueue(new Uint8Array(value));
      } catch (err) {
        _onFinish(err);
        throw err;
      }
    },
    cancel(reason) {
      _onFinish(reason);
      return iterator.return();
    }
  }, {
    highWaterMark: 2
  });
};
exports.trackStream = trackStream;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJzdHJlYW1DaHVuayIsImNodW5rIiwiY2h1bmtTaXplIiwibGVuIiwiYnl0ZUxlbmd0aCIsInBvcyIsImVuZCIsInNsaWNlIiwiZXhwb3J0cyIsInJlYWRCeXRlcyIsIml0ZXJhYmxlIiwicmVhZFN0cmVhbSIsInN0cmVhbSIsIlN5bWJvbCIsImFzeW5jSXRlcmF0b3IiLCJyZWFkZXIiLCJnZXRSZWFkZXIiLCJkb25lIiwidmFsdWUiLCJyZWFkIiwiY2FuY2VsIiwidHJhY2tTdHJlYW0iLCJvblByb2dyZXNzIiwib25GaW5pc2giLCJpdGVyYXRvciIsImJ5dGVzIiwiX29uRmluaXNoIiwiZSIsIlJlYWRhYmxlU3RyZWFtIiwicHVsbCIsImNvbnRyb2xsZXIiLCJuZXh0IiwiY2xvc2UiLCJsb2FkZWRCeXRlcyIsImVucXVldWUiLCJVaW50OEFycmF5IiwiZXJyIiwicmVhc29uIiwicmV0dXJuIiwiaGlnaFdhdGVyTWFyayJdLCJzb3VyY2VzIjpbInRyYWNrU3RyZWFtLmpzIl0sInNvdXJjZXNDb250ZW50IjpbIlxuZXhwb3J0IGNvbnN0IHN0cmVhbUNodW5rID0gZnVuY3Rpb24qIChjaHVuaywgY2h1bmtTaXplKSB7XG4gIGxldCBsZW4gPSBjaHVuay5ieXRlTGVuZ3RoO1xuXG4gIGlmICghY2h1bmtTaXplIHx8IGxlbiA8IGNodW5rU2l6ZSkge1xuICAgIHlpZWxkIGNodW5rO1xuICAgIHJldHVybjtcbiAgfVxuXG4gIGxldCBwb3MgPSAwO1xuICBsZXQgZW5kO1xuXG4gIHdoaWxlIChwb3MgPCBsZW4pIHtcbiAgICBlbmQgPSBwb3MgKyBjaHVua1NpemU7XG4gICAgeWllbGQgY2h1bmsuc2xpY2UocG9zLCBlbmQpO1xuICAgIHBvcyA9IGVuZDtcbiAgfVxufVxuXG5leHBvcnQgY29uc3QgcmVhZEJ5dGVzID0gYXN5bmMgZnVuY3Rpb24qIChpdGVyYWJsZSwgY2h1bmtTaXplKSB7XG4gIGZvciBhd2FpdCAoY29uc3QgY2h1bmsgb2YgcmVhZFN0cmVhbShpdGVyYWJsZSkpIHtcbiAgICB5aWVsZCogc3RyZWFtQ2h1bmsoY2h1bmssIGNodW5rU2l6ZSk7XG4gIH1cbn1cblxuY29uc3QgcmVhZFN0cmVhbSA9IGFzeW5jIGZ1bmN0aW9uKiAoc3RyZWFtKSB7XG4gIGlmIChzdHJlYW1bU3ltYm9sLmFzeW5jSXRlcmF0b3JdKSB7XG4gICAgeWllbGQqIHN0cmVhbTtcbiAgICByZXR1cm47XG4gIH1cblxuICBjb25zdCByZWFkZXIgPSBzdHJlYW0uZ2V0UmVhZGVyKCk7XG4gIHRyeSB7XG4gICAgZm9yICg7Oykge1xuICAgICAgY29uc3Qge2RvbmUsIHZhbHVlfSA9IGF3YWl0IHJlYWRlci5yZWFkKCk7XG4gICAgICBpZiAoZG9uZSkge1xuICAgICAgICBicmVhaztcbiAgICAgIH1cbiAgICAgIHlpZWxkIHZhbHVlO1xuICAgIH1cbiAgfSBmaW5hbGx5IHtcbiAgICBhd2FpdCByZWFkZXIuY2FuY2VsKCk7XG4gIH1cbn1cblxuZXhwb3J0IGNvbnN0IHRyYWNrU3RyZWFtID0gKHN0cmVhbSwgY2h1bmtTaXplLCBvblByb2dyZXNzLCBvbkZpbmlzaCkgPT4ge1xuICBjb25zdCBpdGVyYXRvciA9IHJlYWRCeXRlcyhzdHJlYW0sIGNodW5rU2l6ZSk7XG5cbiAgbGV0IGJ5dGVzID0gMDtcbiAgbGV0IGRvbmU7XG4gIGxldCBfb25GaW5pc2ggPSAoZSkgPT4ge1xuICAgIGlmICghZG9uZSkge1xuICAgICAgZG9uZSA9IHRydWU7XG4gICAgICBvbkZpbmlzaCAmJiBvbkZpbmlzaChlKTtcbiAgICB9XG4gIH1cblxuICByZXR1cm4gbmV3IFJlYWRhYmxlU3RyZWFtKHtcbiAgICBhc3luYyBwdWxsKGNvbnRyb2xsZXIpIHtcbiAgICAgIHRyeSB7XG4gICAgICAgIGNvbnN0IHtkb25lLCB2YWx1ZX0gPSBhd2FpdCBpdGVyYXRvci5uZXh0KCk7XG5cbiAgICAgICAgaWYgKGRvbmUpIHtcbiAgICAgICAgIF9vbkZpbmlzaCgpO1xuICAgICAgICAgIGNvbnRyb2xsZXIuY2xvc2UoKTtcbiAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cblxuICAgICAgICBsZXQgbGVuID0gdmFsdWUuYnl0ZUxlbmd0aDtcbiAgICAgICAgaWYgKG9uUHJvZ3Jlc3MpIHtcbiAgICAgICAgICBsZXQgbG9hZGVkQnl0ZXMgPSBieXRlcyArPSBsZW47XG4gICAgICAgICAgb25Qcm9ncmVzcyhsb2FkZWRCeXRlcyk7XG4gICAgICAgIH1cbiAgICAgICAgY29udHJvbGxlci5lbnF1ZXVlKG5ldyBVaW50OEFycmF5KHZhbHVlKSk7XG4gICAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgICAgX29uRmluaXNoKGVycik7XG4gICAgICAgIHRocm93IGVycjtcbiAgICAgIH1cbiAgICB9LFxuICAgIGNhbmNlbChyZWFzb24pIHtcbiAgICAgIF9vbkZpbmlzaChyZWFzb24pO1xuICAgICAgcmV0dXJuIGl0ZXJhdG9yLnJldHVybigpO1xuICAgIH1cbiAgfSwge1xuICAgIGhpZ2hXYXRlck1hcms6IDJcbiAgfSlcbn1cbiJdLCJtYXBwaW5ncyI6Ijs7Ozs7O0FBQ08sTUFBTUEsV0FBVyxHQUFHLFVBQUFBLENBQVdDLEtBQUssRUFBRUMsU0FBUyxFQUFFO0VBQ3RELElBQUlDLEdBQUcsR0FBR0YsS0FBSyxDQUFDRyxVQUFVO0VBRTFCLElBQUksQ0FBQ0YsU0FBUyxJQUFJQyxHQUFHLEdBQUdELFNBQVMsRUFBRTtJQUNqQyxNQUFNRCxLQUFLO0lBQ1g7RUFDRjtFQUVBLElBQUlJLEdBQUcsR0FBRyxDQUFDO0VBQ1gsSUFBSUMsR0FBRztFQUVQLE9BQU9ELEdBQUcsR0FBR0YsR0FBRyxFQUFFO0lBQ2hCRyxHQUFHLEdBQUdELEdBQUcsR0FBR0gsU0FBUztJQUNyQixNQUFNRCxLQUFLLENBQUNNLEtBQUssQ0FBQ0YsR0FBRyxFQUFFQyxHQUFHLENBQUM7SUFDM0JELEdBQUcsR0FBR0MsR0FBRztFQUNYO0FBQ0YsQ0FBQztBQUFBRSxPQUFBLENBQUFSLFdBQUEsR0FBQUEsV0FBQTtBQUVNLE1BQU1TLFNBQVMsR0FBRyxnQkFB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