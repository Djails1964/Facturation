{"version":3,"names":["_util","_interopRequireDefault","require","_stream","_utils","_readBlob","_index","e","__esModule","default","BOUNDARY_ALPHABET","platform","ALPHABET","ALPHA_DIGIT","textEncoder","TextEncoder","util","CRLF","CRLF_BYTES","encode","CRLF_BYTES_COUNT","FormDataPart","constructor","name","value","escapeName","isStringValue","utils","isString","headers","String","replace","type","contentLength","byteLength","size","isTypedArray","readBlob","match","formDataToStream","form","headersHandler","options","tag","boundary","generateString","isFormData","TypeError","length","Error","boundaryBytes","footerBytes","parts","Array","from","entries","map","part","toFiniteNumber","computedHeaders","Number","isFinite","Readable","_default","exports"],"sources":["formDataToStream.js"],"sourcesContent":["import util from 'util';\nimport {Readable} from 'stream';\nimport utils from \"../utils.js\";\nimport readBlob from \"./readBlob.js\";\nimport platform from \"../platform/index.js\";\n\nconst BOUNDARY_ALPHABET = platform.ALPHABET.ALPHA_DIGIT + '-_';\n\nconst textEncoder = typeof TextEncoder === 'function' ? new TextEncoder() : new util.TextEncoder();\n\nconst CRLF = '\\r\\n';\nconst CRLF_BYTES = textEncoder.encode(CRLF);\nconst CRLF_BYTES_COUNT = 2;\n\nclass FormDataPart {\n  constructor(name, value) {\n    const {escapeName} = this.constructor;\n    const isStringValue = utils.isString(value);\n\n    let headers = `Content-Disposition: form-data; name=\"${escapeName(name)}\"${\n      !isStringValue && value.name ? `; filename=\"${escapeName(value.name)}\"` : ''\n    }${CRLF}`;\n\n    if (isStringValue) {\n      value = textEncoder.encode(String(value).replace(/\\r?\\n|\\r\\n?/g, CRLF));\n    } else {\n      headers += `Content-Type: ${value.type || \"application/octet-stream\"}${CRLF}`\n    }\n\n    this.headers = textEncoder.encode(headers + CRLF);\n\n    this.contentLength = isStringValue ? value.byteLength : value.size;\n\n    this.size = this.headers.byteLength + this.contentLength + CRLF_BYTES_COUNT;\n\n    this.name = name;\n    this.value = value;\n  }\n\n  async *encode(){\n    yield this.headers;\n\n    const {value} = this;\n\n    if(utils.isTypedArray(value)) {\n      yield value;\n    } else {\n      yield* readBlob(value);\n    }\n\n    yield CRLF_BYTES;\n  }\n\n  static escapeName(name) {\n      return String(name).replace(/[\\r\\n\"]/g, (match) => ({\n        '\\r' : '%0D',\n        '\\n' : '%0A',\n        '\"' : '%22',\n      }[match]));\n  }\n}\n\nconst formDataToStream = (form, headersHandler, options) => {\n  const {\n    tag = 'form-data-boundary',\n    size = 25,\n    boundary = tag + '-' + platform.generateString(size, BOUNDARY_ALPHABET)\n  } = options || {};\n\n  if(!utils.isFormData(form)) {\n    throw TypeError('FormData instance required');\n  }\n\n  if (boundary.length < 1 || boundary.length > 70) {\n    throw Error('boundary must be 10-70 characters long')\n  }\n\n  const boundaryBytes = textEncoder.encode('--' + boundary + CRLF);\n  const footerBytes = textEncoder.encode('--' + boundary + '--' + CRLF);\n  let contentLength = footerBytes.byteLength;\n\n  const parts = Array.from(form.entries()).map(([name, value]) => {\n    const part = new FormDataPart(name, value);\n    contentLength += part.size;\n    return part;\n  });\n\n  contentLength += boundaryBytes.byteLength * parts.length;\n\n  contentLength = utils.toFiniteNumber(contentLength);\n\n  const computedHeaders = {\n    'Content-Type': `multipart/form-data; boundary=${boundary}`\n  }\n\n  if (Number.isFinite(contentLength)) {\n    computedHeaders['Content-Length'] = contentLength;\n  }\n\n  headersHandler && headersHandler(computedHeaders);\n\n  return Readable.from((async function *() {\n    for(const part of parts) {\n      yield boundaryBytes;\n      yield* part.encode();\n    }\n\n    yield footerBytes;\n  })());\n};\n\nexport default formDataToStream;\n"],"mappings":"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","ignoreList":[]}