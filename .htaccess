# .htaccess - Configuration Apache pour architecture proxy
# Placez ce fichier à la racine : /volume1/web/facturation/.htaccess (Synology)
# ou C:\wamp64\www\facturation\.htaccess (WAMP)

# Activer le moteur de réécriture
RewriteEngine On

# ===================================================
# SÉCURITÉ : Bloquer l'accès aux fichiers sensibles
# ===================================================

# Bloquer .env
<Files ".env">
    Order allow,deny
    Deny from all
</Files>

# Bloquer le dossier vendor
RewriteRule ^api/vendor/ - [F,L]

# Bloquer les fichiers de configuration
RewriteRule ^api/composer\.(json|lock)$ - [F,L]

# ===================================================
# ROUTAGE API : /api/* vers les fichiers PHP
# ===================================================

# Les requêtes /api/* sont traitées normalement par PHP
RewriteCond %{REQUEST_URI} ^/api/
RewriteCond %{REQUEST_FILENAME} -f
RewriteRule ^ - [L]

# ===================================================
# ROUTAGE SPA : Tout le reste vers index.html
# ===================================================

# Ne pas réécrire les fichiers existants
RewriteCond %{REQUEST_FILENAME} !-f
# Ne pas réécrire les dossiers existants
RewriteCond %{REQUEST_FILENAME} !-d
# Ne pas réécrire les requêtes API
RewriteCond %{REQUEST_URI} !^/api/
# Rediriger vers index.html (React SPA)
RewriteRule ^ index.html [L]

# ===================================================
# HEADERS DE SÉCURITÉ
# ===================================================

<IfModule mod_headers.c>
    # Protection XSS
    Header always set X-XSS-Protection "1; mode=block"
    # Empêcher le sniffing MIME
    Header always set X-Content-Type-Options "nosniff"
    # Empêcher le clickjacking
    Header always set X-Frame-Options "SAMEORIGIN"
</IfModule>

# ===================================================
# COMPRESSION GZIP
# ===================================================

<IfModule mod_deflate.c>
    AddOutputFilterByType DEFLATE text/html text/plain text/css
    AddOutputFilterByType DEFLATE application/javascript application/json
    AddOutputFilterByType DEFLATE text/xml application/xml
</IfModule>

# ===================================================
# CACHE STATIQUE
# ===================================================

<IfModule mod_expires.c>
    ExpiresActive On
    
    # Assets React (JS, CSS avec hash)
    ExpiresByType application/javascript "access plus 1 year"
    ExpiresByType text/css "access plus 1 year"
    
    # Images
    ExpiresByType image/jpeg "access plus 1 month"
    ExpiresByType image/png "access plus 1 month"
    ExpiresByType image/svg+xml "access plus 1 month"
    ExpiresByType image/webp "access plus 1 month"
    
    # Fonts
    ExpiresByType font/woff2 "access plus 1 year"
    ExpiresByType font/woff "access plus 1 year"
    
    # HTML - pas de cache (SPA)
    ExpiresByType text/html "access plus 0 seconds"
</IfModule>
